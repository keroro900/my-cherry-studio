# **Cherry Studio 技术架构文档**

**版本**: 2.0

**最后更新**: 2024年12月11日

**文档状态**: 活跃

本文档旨在提供 Cherry Studio 代码库的高层架构视图，帮助开发者理解系统设计、核心模块交互及数据流向。本次更新深度分析了工作流模块架构，识别了架构问题并提出了优化方案。

## **1. 技术栈概览 (Tech Stack)**

Cherry Studio 基于现代化的 Electron + React 生态构建，采用 Monorepo 架构管理。

| 层级               | 技术选型                       | 说明                           |
| :----------------- | :----------------------------- | :----------------------------- |
| **基础框架** | Electron 38                    | 提供跨平台桌面应用能力         |
| **构建工具** | electron-vite+ Rolldown        | 高性能构建与打包               |
| **前端框架** | React 19+ TypeScript           | UI 渲染与强类型约束            |
| **状态管理** | Redux Toolkit+ Redux Persist   | 全局状态管理与本地持久化       |
| **UI 系统**  | Ant Design 5+ Tailwind CSS     | 组件库与原子化样式             |
| **样式方案** | styled-components              | 动态 CSS-in-JS                 |
| **数据库**   | Dexie (IndexedDB)+ Drizzle ORM | 浏览器端存储与主进程 SQLite    |
| **AI 核心**  | Custom AI SDK                  | 自研 AI 核心库，支持中间件模式 |

## **2. 项目结构 (Project Structure)**

项目采用 Yarn Workspaces 管理的 Monorepo 结构，核心代码分为 Electron 主进程、渲染进程及共享包。

```
cherry-studio/
├── packages/                   # 独立子包 (Shared Packages)
│   ├── aiCore/                 # AI SDK 核心 (Provider, Middleware, Tools)
│   ├── shared/                 # 跨进程共享代码 (Types, Constants, Utils)
│   └── mcp-trace/              # MCP (Model Context Protocol) 追踪工具
├── src/
│   ├── main/                   # Electron 主进程 (Node.js 环境)
│   │   ├── ipc.ts              # IPC 通信注册中心 (核心入口)
│   │   ├── services/           # 主进程核心服务 (50+ 服务)
│   │   ├── mcpServers/         # 内置 MCP 服务器实现
│   │   ├── apiServer/          # 本地 API 服务器
│   │   └── knowledge/          # 知识库与向量检索处理
│   ├── preload/                # 预加载脚本 (Context Bridge)
│   └── renderer/               # 渲染进程 (Web 环境)
│       └── src/
│           ├── pages/          # 业务页面 (Home, Settings, Workflow)
│           │   └── workflow/   # 工作流模块 (详见第4章)
│           ├── components/     # 通用 UI 组件 (70+)
│           ├── store/          # Redux Store 配置 (24个 Slice)
│           ├── services/       # 渲染进程服务 (35+ 服务)
│           ├── hooks/          # 自定义 Hooks
│           └── aiCore/         # 前端 AI 调用适配层
```

### **2.1 工作流模块详细结构**

```
src/renderer/src/pages/workflow/
├── engine/                     # 执行引擎
│   ├── WorkflowEngine.ts       # 核心执行引擎 (~2500行，需要拆分)
│   └── AdvancedNodeExecutor.ts # 高级节点执行器
├── nodes/                      # 节点定义与执行
│   ├── base/                   # 基础架构
│   │   ├── NodeRegistry.ts     # 新节点注册系统 (单例模式)
│   │   ├── BaseNodeExecutor.ts # 节点执行器基类
│   │   └── types.ts            # 节点类型定义
│   ├── definitions/            # 节点定义注册表
│   │   └── index.ts            # 旧注册系统 NODE_REGISTRY
│   ├── input/                  # 输入节点 (3个)
│   ├── ai/                     # AI 节点 (2个)
│   ├── image/                  # 图像处理节点 (7个)
│   ├── video/                  # 视频处理节点 (1个)
│   ├── flow/                   # 流程控制节点 (12个)
│   ├── external/               # 外部服务节点 (1个)
│   └── output/                 # 输出节点 (1个)
├── components/                 # UI 组件
│   ├── Canvas/                 # ReactFlow 画布组件
│   ├── Nodes/                  # 节点 UI 组件
│   ├── ConfigForms/            # 节点配置表单 (25个)
│   └── Panels/                 # 布局面板 (Node, Config, Status)
├── services/                   # 工作流服务
│   ├── WorkflowAiService.ts    # AI 调用服务
│   ├── WorkflowStorage.ts      # 工作流存储
│   ├── TaskQueue.ts            # 任务队列管理
│   └── TaskStorage.ts          # 任务结果存储
├── store/                      # Redux 状态管理
│   ├── workflowSlice.ts        # 工作流状态 Slice
│   └── presetSlice.ts          # 预设管理 Slice
└── types/                      # 类型定义
    ├── index.ts                # 主类型定义
    ├── advanced-nodes.ts       # 高级节点类型
    ├── node-schema.ts          # 节点 Schema 定义
    └── node-factory.ts         # 节点工厂类型
```

## **3. 核心架构设计**

### **3.1 IPC 通信架构**

src/main/ipc.ts 是主进程与渲染进程通信的枢纽，注册了超过 200 个 IPC 通道。

* **App**: 应用生命周期、代理设置、重载。
* **File**: 文件读写、上传、下载。
* **MCP**: 模型上下文协议管理 (ListTools, CallTool)。
* **Knowledge**: 知识库创建、RAG 向量搜索。
* **Memory**: 长期记忆存储与检索。
* **Window**: 多窗口管理 (最小化、显示、关闭)。

### **3.2 状态管理 (Redux Store)**

系统包含 24 个 Slice，管理着复杂的应用状态。

* **结构**: rootReducer 包含 assistants, settings, llm, workflow 等模块。
* **持久化策略**:
  * **持久化**: Settings (最大 31KB), Assistants, LLM 配置等。
  * **黑名单 (内存态)**: Messages (聊天记录), Runtime, Workflow (运行时状态)。
* **跨窗口同步**: 通过 StoreSyncService 实现主窗口与辅助窗口（如设置窗口、独立聊天窗口）间的状态实时同步。

### **3.3 服务层模式 (Service Layer)**

业务逻辑被封装在服务层，而非分散在组件中。

* **主进程服务 (src/main/services/)**: 处理文件系统、数据库操作等重型任务。
  * FileStorage: 文件存储管理。
  * SelectionService: 文本划词功能。
  * BackupManager: 负责 WebDAV/S3/本地备份。
* **渲染进程服务 (src/renderer/src/services/)**: 处理 UI 逻辑与 API 调用。
  * StoreSyncService: 状态同步。
  * ApiService: 统一 API 请求封装。

### **3.4 AI Core 架构**

位于 packages/aiCore，是系统的智能核心。

* **设计模式**: 采用中间件 (Middleware) 链式处理请求。
* **适配器**: 支持 OpenAI, Anthropic, Gemini, Mistral, Ollama 等 15+ Provider。
* **功能**: 支持流式响应处理 (Chunk processing)、工具调用 (Function Calling) 及插件系统。

## **4. 工作流引擎 (Workflow Engine)**

工作流模块允许用户通过可视化编排创建复杂的 AI 任务链。

### **4.1 目录结构**

详见第2章工作流模块详细结构。

### **4.2 执行机制**

1. **拓扑排序**: 运行时调用 buildExecutionOrder() 将图结构转换为线性执行序列。
2. **数据流转**: 通过节点间的连线 (Edge) 传递数据。下游节点通过 collectInputs() 从上游获取输出。
3. **执行循环**: 遍历排序后的节点，根据节点类型调用对应的执行器。

### **4.3 节点体系**

#### **4.3.1 节点类型完整列表 (30+节点)**

**输入节点 (Input Nodes) - 3个**

- `IMAGE_INPUT`: 图片输入 - 文件夹路径输入，支持多路径批处理
- `TEXT_INPUT`: 文本输入 - 支持多行文本和模板变量
- `FILE_INPUT`: 文件输入 - 支持视频、音频、文档等多种文件类型

**AI 节点 (AI Nodes) - 2个**

- `QWEN_PROMPT`: Qwen 提示词 - 使用 Qwen 模型生成文本提示词
- `VISION_PROMPT`: 视觉提示词 - 使用视觉模型分析图片生成结构化提示词

**图像处理节点 (Image Nodes) - 7个**

- `GEMINI_EDIT`: Gemini 编辑 - 预设模式图片编辑
- `GEMINI_EDIT_CUSTOM`: Gemini 自定义编辑 - 自定义提示词图片编辑
- `GEMINI_GENERATE`: Gemini 生成 - 文本到图片生成
- `GEMINI_GENERATE_MODEL`: 模特生成 - 生成穿着指定服装的模特图片
- `GEMINI_MODEL_FROM_CLOTHES`: 衣服生成模特 - 从服装图片生成穿着模特
- `GEMINI_ECOM`: 电商实拍图 - SHEIN/TEMU 风格电商主图生成
- `GEMINI_PATTERN`: 图案生成 - 无缝图案/T恤图案/元素派生
- `COMPARE_IMAGE`: 图片对比 - 将原图和新图拼接对比

**视频处理节点 (Video Nodes) - 1个**

- `KLING_IMAGE2VIDEO`: Kling 图生视频 - 使用 Kling AI 将图片转换为视频

**外部服务节点 (External Nodes) - 1个**

- `RUNNINGHUB_APP`: RunningHub 换装 - RunningHub 换装应用集成

**流程控制节点 (Flow Control Nodes) - 12个**

*基础控制节点*

- `CONDITION`: 条件分支 - 根据条件判断执行不同分支
- `SUBFLOW`: 子工作流 - 嵌套执行另一个工作流

*列表批处理节点 (List Nodes)*

- `IMAGE_LIST`: 图片列表 - 管理图片列表，支持批量处理
- `TEXT_LIST`: 文本列表 - 管理文本列表，支持批量 prompt
- `LIST_MERGE`: 列表合并 - 合并多个列表
- `LIST_FILTER`: 列表筛选 - 根据条件筛选列表元素

*数据路由节点 (Pipe Nodes)*

- `PIPE`: 数据管道 - 通用数据管道，支持命名传输
- `PIPE_ROUTER`: 数据路由器 - 根据规则将数据路由到不同管道
- `PIPE_MERGER`: 数据合并器 - 合并多个数据管道

*分支选择节点 (Switch Nodes)*

- `SWITCH`: 条件开关 - 根据条件选择分支
- `MULTI_SWITCH`: 多路选择 - 多个分支选择（类似 switch-case）

*循环执行节点 (Loop Nodes)*

- `LOOP`: 循环执行 - 循环执行工作流片段
- `LOOP_INDEX`: 索引循环 - 按索引循环（for i in range）
- `LOOP_LIST`: 列表循环 - 遍历列表元素（for item in list）

**输出节点 (Output Nodes) - 1个**

- `OUTPUT`: 输出 - 保存或展示工作流结果，支持文件/显示/下载模式

#### **4.3.2 节点分类说明**

| 分类               | 数量 | 用途                 | 状态          |
| ------------------ | ---- | -------------------- | ------------- |
| **Input**    | 3    | 工作流数据输入源     | ✅ 已实现     |
| **AI**       | 2    | LLM 交互和视觉分析   | ✅ 已实现     |
| **Image**    | 8    | 图像生成、编辑、对比 | ✅ 已实现     |
| **Video**    | 1    | 视频生成和处理       | ✅ 已实现     |
| **External** | 1    | 第三方服务集成       | ✅ 已实现     |
| **Flow**     | 12   | 高级流程控制         | ⚠️ 部分实现 |
| **Output**   | 1    | 结果输出和保存       | ✅ 已实现     |

#### **4.3.3 高级节点 (List/Pipe/Switch/Loop)**

高级节点实现了类似 ComfyUI 的批处理和流程控制能力：

**List 节点**: 支持图片和文本的批量处理

- 动态端口管理（最多支持100个输入）
- 支持合并、筛选、映射操作
- 提供索引访问（第N张图片）

**Pipe 节点**: 实现数据路由和管道传输

- 命名管道支持
- 条件路由规则
- 多路合并策略

**Switch 节点**: 条件分支控制

- 值匹配、存在性检查
- 多分支选择（类似 switch-case）
- 默认分支处理

**Loop 节点**: 循环执行控制

- 索引循环（范围）
- 列表遍历
- 条件循环
- 支持中断和延迟

### **4.4 节点注册架构**

**❗ 关键架构问题: 双重注册系统**

当前存在两套并行的节点注册系统：

#### **4.4.1 旧系统: NODE_REGISTRY**

- **位置**: `src/renderer/src/pages/workflow/nodes/definitions/index.ts`
- **类型**: 静态常量 `Record<WorkflowNodeType, NodeDefinition>`
- **特点**:
  - 编译时确定，无法动态加载
  - 所有30+节点静态定义
  - 直接导出使用

#### **4.4.2 新系统: NodeRegistry**

- **位置**: `src/renderer/src/pages/workflow/nodes/base/NodeRegistry.ts`
- **类型**: 单例类，支持动态注册
- **特点**:
  - 支持运行时动态加载节点
  - 支持内置和自定义节点
  - 支持热重载 (HMR)
  - 提供搜索、分类、统计功能

#### **4.4.3 迁移计划**

1. **Phase 1**: 逐步将 NODE_REGISTRY 中的节点迁移到 NodeRegistry
2. **Phase 2**: 废弃 NODE_REGISTRY，统一使用 NodeRegistry
3. **Phase 3**: 实现自定义节点的热加载机制

### **4.5 数据流与连线机制**

工作流采用基于 ReactFlow 的连线机制进行数据传递：

1. **Handle 定义**: 每个节点通过 `inputs` 和 `outputs` 定义输入输出端口
2. **数据类型**: 支持 `text`、`image`、`images`、`video`、`json`、`any` 等数据类型
3. **类型验证**: 连线时进行数据类型兼容性检查
4. **数据传递**: 上游节点输出存储在 `WorkflowExecutionContext.nodeOutputs` 中
5. **输入收集**: 下游节点通过 `collectInputs()` 方法获取上游数据

### **4.6 服务层架构**

工作流模块的服务层结构：

#### **4.6.1 WorkflowAiService**

- **作用**: 封装 Cherry Studio 原生 aiCore 进行 AI 调用
- **功能**: 文本生成、视觉分析、图像生成
- **问题**: 重复实现了部分原生服务功能

#### **4.6.2 存储服务**

- `WorkflowStorage`: 工作流定义的持久化
- `TaskStorage`: 任务结果存储
- `WorkflowResultStorage`: 执行结果缓存

#### **4.6.3 任务管理**

- `TaskQueue`: 任务队列管理
- `WorkflowTaskManager`: 工作流任务调度

### **4.7 与原生功能集成**

#### **4.7.1 已复用的功能**

| 功能                | 原生服务                | 工作流使用方式                     | 复用程度    |
| ------------------- | ----------------------- | ---------------------------------- | ----------- |
| AI 文本生成         | aiCore/ModernAiProvider | WorkflowAiService.generateText()   | ✅ 完全复用 |
| 视觉分析            | aiCore/LegacyAiProvider | WorkflowAiService.visionAnalysis() | ✅ 完全复用 |
| Provider/Model 配置 | store/llm               | 直接读取 Redux Store               | ✅ 完全复用 |

#### **4.7.2 可进一步复用的功能**

| 功能         | 原生服务               | 复用建议                                | 优先级 |
| ------------ | ---------------------- | --------------------------------------- | ------ |
| 图像生成     | ImageGenerationService | 替换 WorkflowAiService 中的图像生成实现 | 🔴 高  |
| 知识库搜索   | KnowledgeService       | 创建 KnowledgeSearchNode                | 🔴 高  |
| 网络搜索     | WebSearchService       | 创建 WebSearchNode                      | 🟡 中  |
| 记忆管理     | MemoryService          | 创建 MemoryNode (搜索/保存)             | 🟡 中  |
| 翻译服务     | TranslateService       | 创建 TranslateNode                      | 🟡 中  |
| Token 计算   | TokenService           | 在节点中显示 token 消耗                 | 🟢 低  |
| MCP 工具调用 | MCPService             | 创建 MCPToolNode                        | 🟡 中  |

## **5. 原生服务层**

### **5.1 主进程服务 (50+ 服务)**

**核心系统服务**

- `AppService`: 应用生命周期管理
- `WindowService`: 多窗口管理
- `FileSystemService`: 文件系统操作
- `ConfigManager`: 配置管理
- `LoggerService`: 日志服务

**AI 与模型服务**

- `MCPService`: 模型上下文协议
- `AnthropicService`: Anthropic API 集成
- `VertexAIService`: Google Vertex AI 集成
- `MistralClientManager`: Mistral 客户端管理
- `CopilotService`: GitHub Copilot 集成

**知识与数据服务**

- `KnowledgeService`: 知识库管理和向量检索
- `MemoryService`: 长期记忆存储与检索
- `SearchService`: 全文搜索服务
- `CacheService`: 缓存管理

**文件与存储服务**

- `FileStorage`: 文件存储抽象层
- `S3Storage`: S3 对象存储
- `WebDav`: WebDAV 网络存储
- `BackupManager`: 备份管理（支持 WebDAV/S3/本地）

**外部集成服务**

- `NutstoreService`: 坚果云集成
- `ObsidianVaultService`: Obsidian 知识库集成
- `PythonService`: Python 环境管理
- `CodeToolsService`: 代码工具集成

### **5.2 渲染进程服务 (35+ 服务)**

**UI 与交互服务**

- `NavigationService`: 路由导航
- `TabsService`: 标签页管理
- `NotificationService`: 通知系统
- `ImagePreviewService`: 图片预览

**AI 与对话服务**

- `ConversationService`: 对话管理
- `AssistantService`: 助手服务
- `ModelService`: 模型管理
- `ProviderService`: AI 提供商管理
- `ImageGenerationService`: 图像生成统一服务

**数据与存储服务**

- `DbService`: 数据库操作
- `MemoryService`: 内存管理
- `CacheService`: 前端缓存
- `BackupService`: 备份操作

**外部服务**

- `WebSearchService`: 网络搜索
- `TranslateService`: 翻译服务
- `OrchestrateService`: 服务编排
- `PyodideService`: 浏览器端 Python 执行

### **5.3 可复用服务清单**

**高复用价值服务 (P0)**

- `ImageGenerationService`: 统一图像生成接口
- `AssistantService`: Provider/Model 获取逻辑
- `KnowledgeService`: RAG 向量检索
- `MemoryService`: 长期记忆管理

**中等复用价值服务 (P1)**

- `WebSearchService`: 网络搜索能力
- `TranslateService`: 多语言翻译
- `TokenService`: Token 使用统计
- `MCPService`: 工具调用扩展

**低复用价值服务 (P2)**

- `NotificationService`: 操作反馈
- `CacheService`: 结果缓存
- `FileStorage`: 文件操作
- `LoggerService`: 日志记录

## **6. 优化任务清单**

### **6.1 架构问题清单**

#### **P0 - 立即修复的关键问题**

**H1: 统一节点注册系统**

- **问题**: 存在 NODE_REGISTRY 和 NodeRegistry 双重注册机制
- **影响**: 代码维护复杂，容易出现不一致
- **涉及文件**:
  - `src/renderer/src/pages/workflow/nodes/definitions/index.ts`
  - `src/renderer/src/pages/workflow/nodes/base/NodeRegistry.ts`
  - `src/renderer/src/pages/workflow/engine/WorkflowEngine.ts`

**H2: 拆分 WorkflowEngine.ts**

- **问题**: 单文件约 2500 行，职责过重，难以维护
- **影响**: 代码可读性差，修改风险高
- **建议拆分**:
  - `WorkflowEngine`: 核心执行逻辑
  - `ExecutionContext`: 执行上下文管理
  - `InputCollector`: 输入数据收集
  - `OutputHandler`: 输出处理
  - `NodeScheduler`: 节点调度

**H3: 类型定义去重**

- **问题**: NodeExecutionResult 等关键类型在3处重复定义
- **影响**: 类型不一致可能导致运行时错误
- **重复位置**:
  - `src/renderer/src/pages/workflow/engine/WorkflowEngine.ts:45`
  - `src/renderer/src/pages/workflow/types/index.ts:119`
  - `src/renderer/src/pages/workflow/nodes/base/types.ts:121`

#### **P1 - 短期优化任务**

**M1: 复用原生 ImageGenerationService**

- **问题**: WorkflowAiService 重复实现图像生成逻辑
- **方案**: WorkflowAiService 调用 ImageGenerationService 接口
- **收益**: 减少重复代码，统一图像生成逻辑

**M2: 复用原生 Provider/Model 获取逻辑**

- **问题**: `getProviderAndModel()` 在多处重复实现
- **方案**: 使用 `AssistantService.getProviderByModel()` 统一接口
- **收益**: 简化代码，保证一致性

**M3: 实现批处理执行**

- **问题**: 当前只支持单次执行，缺乏批量处理能力
- **方案**: 创建 BatchExecutor 类，支持批量数据处理
- **文件**: `src/renderer/src/pages/workflow/engine/BatchExecutor.ts`

**M4: 实现执行前检查 (Pre-flight Check)**

- **问题**: 运行前不验证工作流完整性，易出现运行时错误
- **方案**: 检查孤立节点、缺失参数、连线兼容性
- **文件**: `src/renderer/src/pages/workflow/engine/PreflightChecker.ts`

#### **P2 - 中长期规划**

**L1: 集成知识库搜索节点**

- 创建 `KNOWLEDGE_SEARCH` 节点类型
- 复用 KnowledgeService 的 RAG 检索能力
- 支持向量相似度搜索和关键词检索

**L2: 集成记忆管理节点**

- 创建 `MEMORY_SEARCH` / `MEMORY_SAVE` 节点
- 复用 MemoryService 的长期记忆功能
- 支持上下文记忆和检索

**L3: 集成 MCP 工具调用节点**

- 创建 `MCP_TOOL` 节点类型
- 复用 MCPService 的工具调用能力
- 支持动态工具发现和调用

**L4: 实现工作流版本控制**

- 保存工作流版本快照
- 支持版本比较和回滚
- 集成 Git-like 版本管理

**L5: 实现单节点预览**

- 右键菜单添加"预览执行"功能
- 模拟上游输出进行单节点测试
- 加快节点调试效率

### **6.2 优化任务分类 (P0/P1/P2)**

| 优先级                    | 任务数量 | 预计工期 | 主要收益                         |
| ------------------------- | -------- | -------- | -------------------------------- |
| **P0 (立即执行)**   | 3        | 1-2 周   | 修复关键架构问题，提升代码质量   |
| **P1 (短期规划)**   | 4        | 2-4 周   | 功能增强，代码复用，用户体验提升 |
| **P2 (中长期规划)** | 5        | 1-3 月   | 生态集成，高级功能，扩展性提升   |

### **6.3 实施路线图**

#### **阶段一: 架构修复 (2周)**

1. **Week 1**: 统一节点注册系统 (H1) + 类型定义去重 (H3)
2. **Week 2**: 拆分 WorkflowEngine.ts (H2)

#### **阶段二: 功能增强 (4周)**

3. **Week 3-4**: 复用原生服务 (M1, M2)
4. **Week 5-6**: 批处理执行 (M3) + 执行前检查 (M4)

#### **阶段三: 生态集成 (12周)**

5. **Week 7-10**: 知识库集成 (L1) + 记忆管理 (L2)
6. **Week 11-14**: MCP 工具集成 (L3) + 版本控制 (L4)
7. **Week 15-18**: 单节点预览 (L5) + 性能优化

## **附录**

### **A. 节点类型枚举完整列表**

```typescript
export enum WorkflowNodeType {
  // 输入节点 (3个)
  IMAGE_INPUT = 'image_input',
  TEXT_INPUT = 'text_input', 
  FILE_INPUT = 'file_input',

  // AI 节点 (2个)
  QWEN_PROMPT = 'qwen_prompt',
  VISION_PROMPT = 'vision_prompt',

  // 图像处理节点 (8个)
  GEMINI_EDIT = 'gemini_edit',
  GEMINI_EDIT_CUSTOM = 'gemini_edit_custom',
  GEMINI_GENERATE = 'gemini_generate', 
  GEMINI_GENERATE_MODEL = 'gemini_generate_model',
  GEMINI_MODEL_FROM_CLOTHES = 'gemini_model_from_clothes',
  GEMINI_ECOM = 'gemini_ecom',
  GEMINI_PATTERN = 'gemini_pattern',
  COMPARE_IMAGE = 'compare_image',

  // 视频节点 (1个)
  KLING_IMAGE2VIDEO = 'kling_image2video',

  // 外部服务节点 (1个) 
  RUNNINGHUB_APP = 'runninghub_app',

  // 流程控制节点 (12个)
  CONDITION = 'condition',
  SUBFLOW = 'subflow',
  
  // List 批处理节点
  IMAGE_LIST = 'image_list',
  TEXT_LIST = 'text_list', 
  LIST_MERGE = 'list_merge',
  LIST_FILTER = 'list_filter',

  // Pipe 数据路由节点
  PIPE = 'pipe',
  PIPE_ROUTER = 'pipe_router',
  PIPE_MERGER = 'pipe_merger',

  // Switch 条件分支节点
  SWITCH = 'switch',
  MULTI_SWITCH = 'multi_switch',

  // Loop 循环执行节点
  LOOP = 'loop',
  LOOP_INDEX = 'loop_index', 
  LOOP_LIST = 'loop_list',

  // 输出节点 (1个)
  OUTPUT = 'output'
}
```

### **B. 关键文件路径索引**

#### **工作流模块核心文件**

- **引擎**: `src/renderer/src/pages/workflow/engine/WorkflowEngine.ts`
- **节点注册**: `src/renderer/src/pages/workflow/nodes/base/NodeRegistry.ts`
- **节点定义**: `src/renderer/src/pages/workflow/nodes/definitions/index.ts`
- **AI服务**: `src/renderer/src/pages/workflow/services/WorkflowAiService.ts`
- **类型定义**: `src/renderer/src/pages/workflow/types/index.ts`

#### **原生服务文件**

- **图像生成**: `src/renderer/src/services/ImageGenerationService.ts`
- **助手服务**: `src/renderer/src/services/AssistantService.ts`
- **知识库服务**: `src/main/services/KnowledgeService.ts`
- **记忆服务**: `src/main/services/memory/MemoryService.ts`
- **MCP服务**: `src/main/services/MCPService.ts`

#### **配置文件**

- **主配置**: `src/renderer/src/pages/workflow/WorkflowPage.tsx`
- **状态管理**: `src/renderer/src/pages/workflow/store/workflowSlice.ts`
- **IPC通信**: `src/main/ipc.ts`

---

**文档维护**: 本文档将随着架构演进持续更新。如有问题或建议，请联系开发团队。
