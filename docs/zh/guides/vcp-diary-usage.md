# VCP 日记功能使用指南

> 本指南介绍如何在 Cherry Studio 中使用 VCP 日记功能，实现知识库的智能检索与 AI 记忆增强。

---

## 目录

1. [功能概述](#功能概述)
2. [快速开始](#快速开始)
3. [日记声明语法](#日记声明语法)
4. [知识库日记模式](#知识库日记模式)
5. [ShowVCP 调试面板](#showvcp-调试面板)
6. [高级功能](#高级功能)
7. [常见问题](#常见问题)

---

## 功能概述

VCP (Virtual Character Protocol) 日记功能让 AI 助手能够：

- **智能检索知识库**：在对话时自动检索相关知识
- **记忆对话内容**：AI 可以主动写入重要信息到知识库
- **上下文增强**：根据对话进度自动注入相关上下文
- **调试透明化**：通过 ShowVCP 面板实时查看检索过程

### 核心特性

| 特性 | 说明 |
|------|------|
| 4 种检索模式 | 全文注入、RAG 检索、阈值全文、阈值 RAG |
| 知识库关联 | 助手可关联多个知识库 |
| 自动摘要 | AI 自动生成日记摘要 |
| 实时调试 | ShowVCP 面板显示完整调用链 |

---

## 快速开始

### 步骤 1: 创建知识库

1. 打开 **知识库** 页面
2. 点击 **新建知识库**
3. 输入知识库名称（如：`工作日志`）
4. 添加文档或直接创建日记条目

### 步骤 2: 关联助手与知识库

1. 打开 **助手设置**
2. 找到 **知识库** 配置项
3. 选择要关联的知识库
4. 保存设置

### 步骤 3: 使用日记声明语法

在助手的系统提示词中添加日记声明：

```
你是一个智能助手。

在回答问题前，请参考以下知识：
[[工作日志]]

请根据用户的问题和知识库内容提供帮助。
```

### 步骤 4: 开始对话

现在与助手对话时，它会自动：
1. 解析系统提示词中的日记声明
2. 根据用户问题检索知识库
3. 将相关内容注入到对话上下文

---

## 日记声明语法

VCP 支持 4 种日记声明语法，控制不同的检索模式：

### 1. RAG 检索 `[[知识库名]]`

```
[[工作日志]]
```

- **模式**: 语义相似度检索
- **特点**: 返回与用户问题最相关的 Top-K 片段
- **适用**: 需要精准匹配的场景

### 2. 全文注入 `{{知识库名}}`

```
{{产品手册}}
```

- **模式**: 注入完整知识库内容
- **特点**: 将整个知识库内容添加到上下文
- **适用**: 小型知识库，需要完整参考

### 3. 阈值 RAG `《《知识库名》》`

```
《《技术文档》》
```

- **模式**: 带相似度阈值的 RAG 检索
- **特点**: 只有相似度超过阈值才注入
- **适用**: 避免无关内容干扰

### 4. 阈值全文 `<<知识库名>>`

```
<<FAQ列表>>
```

- **模式**: 带相似度阈值的全文注入
- **特点**: 平均相似度达标才注入完整内容
- **适用**: 条件性全文参考

### 混合使用示例

```
你是一个时尚顾问助手。

## 核心知识
{{品牌介绍}}

## 参考数据
[[2024春季趋势]]
《《色彩搭配指南》》

请根据以上知识回答用户关于时尚搭配的问题。
```

---

## 知识库日记模式

在知识库页面，选择 **日记模式** 可以使用专门的日记管理功能。

### 日记编辑器

日记编辑器支持：
- VCP 语法高亮显示
- 实时预览检索声明
- 语法图例提示

### 知识浏览器

浏览器功能：
- 查看所有日记条目
- 搜索和过滤
- 编辑和删除条目
- 查看分块详情

### 标签管理

标签功能：
- 自动从日记内容提取标签
- 标签统计和可视化
- 语义组管理

---

## ShowVCP 调试面板

ShowVCP 是 VCP 的透明化调试机制，让你实时"透视" AI 与知识库的交互。

### 启用 ShowVCP

1. 打开 **设置** > **开发者选项**
2. 启用 **ShowVCP 调试模式**
3. 配置显示选项：
   - 显示时间戳
   - 显示执行耗时
   - 显示调用参数
   - 显示返回结果

### 调试面板信息

开启后，每次对话会显示：

```
╔══════════════════════════════════════════════════════════════╗
║                     ShowVCP 调试信息                          ║
╠══════════════════════════════════════════════════════════════╣
║ Agent: 时尚顾问
║ 会话 ID: vcp-session-xxx
║ 开始时间: 2024-12-28T10:30:00.000Z
╠══════════════════════════════════════════════════════════════╣
║ 调用记录 (3 次):
╟──────────────────────────────────────────────────────────────╢
║ 1. [✓] context::agent_load (12ms)
║ 2. [✓] diary_read::diary_search (156ms)
║    参数: {"query":"春季流行色","knowledgeBaseId":"kb-xxx"}
║ 3. [✓] context::context_rules_execute (8ms)
╠══════════════════════════════════════════════════════════════╣
║ 上下文注入 (2 条):
║ 1. 2024春季色彩以粉彩色调为主，薰衣草紫和...
║ 2. 春季廓形趋势偏向宽松舒适，强调自然线条...
╚══════════════════════════════════════════════════════════════╝
```

### 调用类型说明

| 类型 | 说明 |
|------|------|
| `context::agent_load` | 加载 VCP Agent 配置 |
| `diary_read::diary_search` | 执行日记/知识库检索 |
| `context::context_rules_execute` | 执行上下文注入规则 |
| `diary_write::diary_write` | AI 写入日记 |
| `injection` | 上下文内容注入 |

---

## 高级功能

### AI 自动写入日记

AI 可以在对话中主动写入日记。支持以下触发方式：

#### 1. 工具调用方式

如果 AI 支持工具调用，可以直接调用 `diary_write` 工具。

#### 2. 标记方式

AI 可以在输出中使用特殊标记：

```
<<<[DIARY_WRITE]>>>
今天与用户讨论了春季色彩趋势，用户偏好柔和的粉彩色调。
<<<[/DIARY_WRITE]>>>
```

或中文标记：

```
【日记写入】
重要发现：用户对可持续时尚有浓厚兴趣。
【/日记写入】
```

### 日记摘要功能

系统支持自动生成日记摘要：

1. 在日记浏览器中选择多条日记
2. 点击 **生成摘要**
3. AI 会自动分析并生成综合摘要
4. 摘要会保存为新的日记条目，标记 `auto-summary` 标签

### UnifiedAssistant 配置

高级用户可以使用统一 Assistant 配置进行精细控制：

```typescript
// UnifiedAssistant 配置示例
{
  name: "fashion_advisor",
  displayName: "时尚顾问",
  systemPrompt: "你是专业的时尚顾问...\n\n[[时尚知识库]]",
  memory: {
    enabled: true,
    backends: ["diary", "memory"],
    diaryBookName: "时尚日记",
    windowSize: 10
  },
  vcpConfig: {
    knowledgeBaseId: "kb-fashion-xxx",
    knowledgeBaseName: "时尚知识库"
  },
  knowledgeBases: [
    { id: "kb-fashion-xxx", name: "时尚知识库" }
  ]
}
```

---

## 常见问题

### Q1: 为什么知识库检索没有结果？

**可能原因：**
1. 知识库名称拼写错误
2. 知识库内容为空
3. 用户问题与知识库内容相关度太低

**解决方法：**
- 检查日记声明中的知识库名称是否正确
- 确保知识库已添加相关文档
- 尝试使用全文注入模式 `{{}}` 测试

### Q2: ShowVCP 面板没有显示？

**解决方法：**
1. 确认已在设置中启用 ShowVCP
2. 确认助手已关联知识库或启用记忆
3. 重启应用后重试

### Q3: 如何选择合适的检索模式？

| 场景 | 推荐模式 |
|------|----------|
| 问答类应用 | `[[]]` RAG 检索 |
| 参考手册 | `{{}}` 全文注入 |
| 大型知识库 | `《《》》` 阈值 RAG |
| 可选参考 | `<<>>` 阈值全文 |

### Q4: 日记写入没有生效？

**检查项：**
1. 确认 AI 模型支持工具调用或能识别标记
2. 检查 ShowVCP 面板中的 `diary_write` 调用状态
3. 确认知识库有写入权限

### Q5: 如何提高检索质量？

**优化建议：**
1. 使用清晰的文档标题
2. 为日记添加相关标签
3. 定期生成摘要整理内容
4. 调整检索的 Top-K 参数

---

## 相关链接

- [VCP 架构文档](../VCP-ARCHITECTURE.md)
- [VCP 扩展开发指南](../VCP-EXTENSIONS-USAGE.md)
- [知识库使用指南](./memory.md)

---

> 文档版本: 1.0.0
> 最后更新: 2024-12-28
