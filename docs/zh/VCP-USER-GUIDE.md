# VCP 功能用户指南

> Cherry Studio VCP (Variable & Command Protocol) 智能增强系统使用手册

---

## 目录

1. [功能概览](#1-功能概览)
2. [快速开始](#2-快速开始)
3. [VCP 日记模式](#3-vcp-日记模式)
4. [Agent 管理](#4-agent-管理)
5. [上下文注入](#5-上下文注入)
6. [日记声明语法](#6-日记声明语法)
7. [高级检索修饰符](#7-高级检索修饰符)
8. [模板变量](#8-模板变量)
9. [工具调用协议](#9-工具调用协议)
10. [常见问题](#10-常见问题)

---

## 1. 功能概览

VCP 是 Cherry Studio 的智能上下文增强系统，集成在**知识库**模块中，提供以下能力：

| 功能 | 说明 |
|------|------|
| **VCP 日记** | 4 种日记声明模式，自动注入相关知识 |
| **Agent 管理** | 可配置的智能助手，支持模板变量和系统提示词 |
| **上下文注入** | 灵活的注入规则和预设，支持多种触发条件 |
| **工具调用** | 标准化的 TOOL_REQUEST/TOOL_RESULT 协议 |

---

## 2. 快速开始

### 2.1 进入 VCP 功能

1. 点击左侧边栏的 **知识库** 图标
2. 在左侧选择或创建一个知识库
3. 在顶部标签页中选择 VCP 相关功能：
   - **VCP 日记** - 日记声明编辑
   - **Agent 管理** - VCP Agent 配置
   - **上下文注入** - 注入规则管理

### 2.2 知识库标签页总览

| 标签 | 图标 | 功能 |
|------|------|------|
| 文件 | 📖 | 上传和管理文件 |
| 笔记 | 📓 | 文本笔记管理 |
| **VCP 日记** | 📖 | VCP 日记声明编辑（核心功能） |
| 目录 | 📁 | 知识库目录结构 |
| 网址 | 🔗 | 网页内容管理 |
| 网站 | 🌐 | 站点地图管理 |
| **Agent 管理** | 🤖 | 配置 VCP Agent |
| **上下文注入** | ✨ | 设置上下文注入规则 |

---

## 3. VCP 日记模式

### 3.1 进入日记模式

在知识库页面，点击 **VCP 日记** 标签页进入日记模式。

### 3.2 日记模式界面

日记模式包含三个子标签页：

| 子标签 | 图标 | 功能 |
|--------|------|------|
| 日记编辑 | ✏️ | 编写 VCP 日记声明 |
| 知识浏览 | 📖 | 浏览已有日记文件 |
| 标签管理 | 🏷️ | 管理 RAG 标签和语义组 |

### 3.3 日记编辑器功能

编辑器界面包含：

**工具栏 - 插入声明：**
| 按钮 | 语法 | 颜色 | 说明 |
|------|------|------|------|
| `{{...}}` | 全文注入 | 绿色 | 注入知识库全部内容 |
| `[[...]]` | RAG 片段 | 蓝色 | 向量检索相关片段 |
| `<<...>>` | 阈值全文 | 黄色 | 相似度达标时才注入全文 |
| `《《...》》` | 阈值 RAG | 紫色 | 相似度达标时才检索片段 |

**工具栏 - 修饰符：**
| 按钮 | 功能 |
|------|------|
| 时间感知 | 添加 `::Time` 修饰符 |
| 语义组 | 添加 `::Group` 修饰符 |
| 标签网络 | 添加 `::TagMemo` 修饰符 |
| 精排 | 添加 `::Rerank` 修饰符 |

**实时预览区域：**
- 右侧显示日记声明的语法高亮效果
- 不同声明类型用不同颜色标识

**状态栏：**
- 字符数统计
- 声明数量统计
- 光标位置

### 3.4 知识浏览器

在 **知识浏览** 标签页中，可以：
- 查看所有日记文件列表
- 按标签筛选文件
- 点击文件直接编辑
- 删除或重新索引文件

### 3.5 标签管理

在 **标签管理** 标签页中，可以：
- 查看自动提取的 RAG 标签
- 管理语义组配置
- 查看标签使用频率

---

## 4. Agent 管理

### 4.1 进入 Agent 管理

在知识库页面，点击 **Agent 管理** 标签页。

### 4.2 Agent 管理界面

Agent 管理包含三个子标签页：

| 子标签 | 功能 |
|--------|------|
| Agent 列表 | 创建、编辑、删除、激活 Agent |
| 变量管理 | 管理提示词变量 |
| 模板管理 | 管理提示词模板 |

### 4.3 创建 Agent

1. 点击 **新建 Agent** 按钮
2. 填写配置信息：

| 字段 | 说明 |
|------|------|
| 名称 | Agent 名称 |
| 分类 | 分类标签 |
| 描述 | Agent 描述 |
| 系统提示词 | 核心提示词（支持 `{{变量}}` 语法） |
| 个性设定 | 个性描述 |
| 背景故事 | 背景信息 |
| 问候语 | 开场问候 |
| 标签 | 标签列表 |

### 4.4 Agent 系统提示词示例

```markdown
你是 {{VarAssistantName}}，一位专业的 {{VarExpertise}} 顾问。

当前时间：{{current_datetime}}

参考以下知识库内容：
[[产品文档::Time::K5]]
{{FAQ知识库}}

用户问题：{{TarUserInput}}

请根据以上信息提供专业回答。
```

### 4.5 变量管理

在 **变量管理** 标签页中，可以创建和管理变量：

| 字段 | 说明 |
|------|------|
| 变量名 | 变量标识符（如 `user_name`） |
| 值 | 变量值 |
| 作用域 | `全局` / `Agent 级别` / `会话级别` |
| 分类 | 分类标签 |
| 描述 | 变量描述 |

### 4.6 模板管理

在 **模板管理** 标签页中，可以：
- 创建提示词模板
- 使用 `{{变量}}` 语法
- 渲染预览模板效果
- 复制模板内容

---

## 5. 上下文注入

### 5.1 进入上下文注入

在知识库页面，点击 **上下文注入** 标签页。

### 5.2 上下文注入界面

上下文注入包含两个子标签页：

| 子标签 | 功能 |
|--------|------|
| 注入规则 | 创建和管理注入规则 |
| 预设管理 | 管理规则预设 |

### 5.3 创建注入规则

1. 点击 **新建规则** 按钮
2. 配置规则：

**基本配置：**
| 字段 | 说明 |
|------|------|
| 规则名称 | 规则标识 |
| 注入位置 | 见下表 |
| 注入内容 | 要注入的文本（支持变量） |
| 优先级 | 1-100，数字越大优先级越高 |

**注入位置：**
| 位置 | 颜色 | 说明 |
|------|------|------|
| 系统提示词开头 | 蓝色 | 在系统提示词开头插入 |
| 系统提示词结尾 | 青色 | 在系统提示词结尾插入 |
| 上下文开头 | 绿色 | 在对话上下文开头插入 |
| 上下文结尾 | 青绿色 | 在对话上下文结尾插入 |
| 用户消息前 | 橙色 | 在用户消息前插入 |
| 用户消息后 | 金色 | 在用户消息后插入 |
| 助手消息前 | 紫色 | 在助手消息前插入 |
| 隐藏注入 | 灰色 | 注入但不显示 |

**触发条件：**
| 类型 | 说明 |
|------|------|
| 始终触发 | 每次对话都触发 |
| 关键词触发 | 检测到关键词时触发 |
| 正则匹配 | 正则表达式匹配时触发 |
| 对话轮次 | 达到指定轮次时触发 |
| 时间触发 | 特定时间触发 |
| 随机触发 | 按概率随机触发 |
| 上下文长度 | 上下文达到指定长度时触发 |

**高级配置：**
| 字段 | 说明 |
|------|------|
| 触发逻辑 | 全部满足 (AND) / 任一满足 (OR) |
| 冷却时间 | 触发后的冷却秒数 |
| 最大触发次数 | 最多触发多少次 |

### 5.4 预设管理

预设是一组规则的集合，可以快速切换：

**快速创建预设：**
- **导演模式** - 适合故事创作场景
- **角色扮演增强** - 适合角色扮演场景

**自定义预设：**
1. 点击 **新建预设**
2. 选择要包含的规则
3. 保存并激活

### 5.5 测试注入

点击 **测试注入** 按钮，可以：
- 模拟对话轮次
- 模拟上下文长度
- 模拟用户消息
- 查看触发的注入规则

---

## 6. 日记声明语法

### 6.1 四种基础模式

| 语法 | 模式 | 说明 |
|------|------|------|
| `{{知识库名}}` | 全文注入 | 注入知识库全部内容 |
| `[[知识库名]]` | RAG 片段 | 向量检索相关片段 |
| `<<知识库名>>` | 阈值全文 | 相似度达标时才注入全文 |
| `《《知识库名》》` | 阈值 RAG | 相似度达标时才检索片段 |

### 6.2 动态 K 值语法

使用 `知识库名:系数` 格式动态调整检索数量：

```markdown
# 基础语法：知识库名:系数
[[产品文档:1.5]]      # topK = 10 * 1.5 = 15 条结果
[[FAQ:0.5]]           # topK = 10 * 0.5 = 5 条结果
[[技术文档:2.0]]      # topK = 10 * 2.0 = 20 条结果

# 与其他修饰符组合
[[知识库:1.5::Time::TagMemo0.7]]
```

**说明**:
- 默认基础 K 值为 10
- 系数范围建议 0.1 ~ 5.0
- 可与其他修饰符（如 `::Time`、`::TagMemo`）组合使用

### 6.3 使用示例

```markdown
# 全文注入 - 适合小型知识库
{{公司规章制度}}

# RAG 检索 - 适合大型知识库（推荐）
[[产品文档]]

# 阈值控制 - 只在相关时注入
<<客户案例::Threshold0.7>>

# 中文书名号语法
《《技术文档》》
```

### 6.3 多知识库组合

```markdown
请参考以下资料：

[[产品手册]]
[[FAQ文档]]
{{最新公告}}

基于以上内容回答用户问题。
```

---

## 7. 高级检索修饰符

### 7.1 修饰符语法

在知识库名后添加 `::修饰符` 来启用增强功能：

```
[[知识库名::修饰符1::修饰符2]]
```

### 7.2 可用修饰符列表

| 修饰符 | 说明 | 示例 |
|--------|------|------|
| `::Time` | 时间感知检索，优先返回近期内容 | `[[日记::Time]]` |
| `::Group` | 使用默认语义组增强 | `[[时尚::Group]]` |
| `::Group(a,b,c)` | 使用自定义语义组 | `[[时尚::Group(颜色,风格,场合)]]` |
| `::TagMemo0.65` | 启用标签网络，阈值 0.65 | `[[知识库::TagMemo0.7]]` |
| `::TopK10` | 返回前 10 条结果 | `[[文档::TopK5]]` |
| `::K10` | TopK 的简写 | `[[文档::K5]]` |
| `::Threshold0.8` | 设置相似度阈值 | `[[文档::Threshold0.6]]` |
| `::Rerank` | 启用 Rerank 精排 | `[[文档::Rerank]]` |
| `::MeshMemo` | 使用 MeshMemo 后端 | `[[知识库::MeshMemo]]` |
| `::LightMemo` | 使用 LightMemo 后端 | `[[知识库::LightMemo]]` |
| `::DeepMemo` | 使用 DeepMemo 后端 | `[[知识库::DeepMemo]]` |

### 7.3 组合使用示例

```markdown
# 时间感知 + 标签增强 + 限制结果数
[[时尚日记::Time::TagMemo0.6::K5]]

# 深度检索 + 高阈值
[[技术文档::DeepMemo::Threshold0.8]]

# 自定义语义组
[[服装推荐::Group(颜色,款式,材质)::TopK10]]
```

### 7.4 检索后端对比

| 后端 | 特点 | 适用场景 |
|------|------|----------|
| **LightMemo** | BM25 + 向量，轻量快速 | 日常检索，小型知识库 |
| **DeepMemo** | Tantivy + Rerank，深度精准 | 专业文档，高精度需求 |
| **MeshMemo** | 多维过滤 + MMR 多样性 | 复杂查询，多角度召回 |

---

## 8. 模板变量

### 8.1 变量类型

| 前缀 | 类型 | 说明 | 示例 |
|------|------|------|------|
| `Tar` | 目标变量 | 用户输入相关 | `{{TarUserInput}}` |
| `Sar` | 会话变量 | 当前会话信息 | `{{SarSessionId}}` |
| `Var` | 自定义变量 | Agent 定义的变量 | `{{VarProductName}}` |

### 8.2 系统内置变量

```
{{current_date}}      - 当前日期 (2025-12-29)
{{current_time}}      - 当前时间 (14:30:00)
{{current_datetime}}  - 完整日期时间
{{weekday}}           - 星期几
{{TarUserInput}}      - 用户最新输入
{{TarQuery}}          - 用户查询内容
```

### 8.3 在系统提示词中使用

```markdown
你是 {{VarAssistantName}}，一位专业的 {{VarExpertise}} 顾问。

当前时间：{{current_datetime}}

用户问题：{{TarUserInput}}

请根据以下知识库回答：
[[{{VarKnowledgeBase}}]]
```

---

## 9. 工具调用协议

### 9.1 TOOL_REQUEST 格式

AI 可以通过以下格式请求调用工具：

**标准格式（推荐）：**
```
<<<[TOOL_REQUEST]>>>
tool_name:「始」image_generate「末」
prompt:「始」一只可爱的猫咪「末」
size:「始」1024x1024「末」
<<<[/TOOL_REQUEST]>>>
```

**简化格式：**
```
<<<[TOOL_REQUEST]>>>
tool_name: image_generate
prompt: 一只可爱的猫咪
size: 1024x1024
<<<[/TOOL_REQUEST]>>>
```

### 9.2 工具结果渲染

工具执行结果会以结构化方式显示：

**成功结果：**
```
<<<[TOOL_RESULT]>>>
Tool: image_generate
Duration: 3200ms

{"url": "https://...", "width": 1024, "height": 1024}
<<<[/TOOL_RESULT]>>>
```

**错误结果：**
```
<<<[TOOL_ERROR]>>>
Tool: image_generate
Error: API quota exceeded
<<<[/TOOL_ERROR]>>>
```

### 9.3 Key 归一化规则

以下写法等价，系统会自动归一化：

- `image_size` = `imageSize` = `ImageSize` = `IMAGE-SIZE`
- `tool_name` = `toolName` = `pluginName`

### 9.4 异步插件回调

对于长耗时任务（如视频生成），Cherry Studio 支持异步回调机制：

**工作原理：**
1. 调用 MCP 工具时，系统自动注入回调 URL 参数
2. 外部插件完成任务后，通过 HTTP POST 回调结果
3. Cherry Studio 接收回调并通知前端

**注入的参数：**
```
__VCP_CALLBACK_URL__: 完整回调地址（含插件名和任务ID）
__VCP_CALLBACK_BASE_URL__: 回调服务器基础地址
__VCP_PLUGIN_NAME__: 当前插件名称
__VCP_TASK_ID__: 唯一任务ID
```

**回调端点：**
```
POST http://127.0.0.1:6006/plugin-callback/:pluginName/:taskId
Content-Type: application/json

{
  "status": "success",   // "success" | "error"
  "result": "...",       // 成功结果
  "error": "...",        // 错误信息
  "url": "...",          // 可选：资源URL
  "metadata": {}         // 可选：额外数据
}
```

**异步结果占位符：**
```
{{VCP_ASYNC_RESULT::PluginName::TaskID}}
```

在对话中使用此占位符，系统会自动替换为异步任务的结果。

---

## 10. 常见问题

### Q1: 知识库检索没有结果？

**检查项：**
1. 知识库名称是否正确（区分大小写）
2. 知识库是否已创建并包含内容
3. 尝试降低 `::Threshold` 值
4. 检查控制台的错误信息

### Q2: 模板变量没有被替换？

**检查项：**
1. 变量格式是否正确：`{{VarName}}`
2. 是否已在 Agent 管理中定义该变量
3. 变量名是否拼写正确（区分大小写）

### Q3: 工具调用失败？

**检查项：**
1. 检查工具参数是否完整
2. 确认相关 MCP 服务器已启动
3. 查看控制台错误日志

### Q4: 注入规则没有触发？

**检查项：**
1. 确认规则状态为"激活"
2. 检查触发条件是否满足
3. 使用"测试注入"功能调试

### Q5: 如何查看注入的内容？

1. 使用上下文注入的 **测试注入** 功能
2. 查看对话记录中的调试信息

---

## 附录：快速参考卡

### 日记声明速查

```
{{全文}}     [[RAG]]     <<阈值全文>>     《《阈值RAG》》
```

### 常用修饰符组合

```
[[知识库::Time::K5]]           # 时间感知，返回5条
[[知识库::TagMemo0.7::TopK10]] # 标签增强，返回10条
[[知识库::DeepMemo::Threshold0.8]] # 深度检索，高阈值
```

### 模板变量速查

```
{{TarUserInput}}    # 用户输入
{{current_date}}    # 当前日期
{{VarXxx}}          # 自定义变量
```

### TOOL_REQUEST 模板

```
<<<[TOOL_REQUEST]>>>
tool_name: 工具名
参数1: 值1
参数2: 值2
<<<[/TOOL_REQUEST]>>>
```

---

> 更多技术细节请参考 [VCP-ARCHITECTURE.md](../VCP-ARCHITECTURE.md)
