# VCP 内置服务端到端审查（开发者文档）

本文档面向 Cherry Studio 开发者，汇总本次审查中确认的问题与重复实现。清单仅覆盖已审查到的内容，非全量穷尽。

## 错误与缺失清单
- 工具协议解析仅支持 ASCII 冒号与严格「末」闭合，遇到全角冒号 `：` 或尾随标点会解析失败，导致工具请求被忽略。位置：`cherry-studio/src/renderer/src/aiCore/legacy/clients/vcp/VCPProtocolParser.ts:81`、`cherry-studio/src/renderer/src/aiCore/legacy/clients/vcp/VCPProtocolParser.ts:87`、`cherry-studio/src/renderer/src/aiCore/legacy/clients/vcp/VCPProtocolParser.ts:111`、`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:1336`、`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:1342`、`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:1358`、`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:1373`
- 参数归一化规则不一致：VCPProtocolParser 会移除 `_` 与 `-`，vcpContextPlugin 则转为 `snake_case`，导致 `tag_boost` 等参数失配。位置：`cherry-studio/src/renderer/src/aiCore/legacy/clients/vcp/VCPProtocolParser.ts:179`、`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:1457`、`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:1487`
- 工具执行仅走 `vcpUnified`，缺少对内置工具的完整兜底路径，当前仅处理少量内置工具，导致大部分内置服务不可用。位置：`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:1518`、`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:1542`、`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:1576`
- VCPRuntime 未初始化时直接返回失败，且插件未注册时标记 `_pluginNotFound`，执行链路缺少自动初始化/注册。位置：`cherry-studio/src/main/services/UnifiedPluginManager.ts:357`、`cherry-studio/src/main/services/UnifiedPluginManager.ts:378`、`cherry-studio/src/main/services/UnifiedPluginManager.ts:499`
- `VCPUnified_ExecuteTool` IPC 处理器不保证 VCPRuntime 初始化，依赖外部初始化，导致调用链不稳定。位置：`cherry-studio/src/main/services/vcp/VCPPluginIpcHandler.ts:1244`
- 统一工具执行中间件仅在 MCP/VCP 配置存在时启用，默认场景不会处理工具调用。位置：`cherry-studio/src/renderer/src/aiCore/legacy/middleware/VCPToolExecutorMiddleware.ts:80`、`cherry-studio/src/renderer/src/aiCore/legacy/middleware/VCPToolExecutorMiddleware.ts:85`
- 工具调用日志写入 ShowVCP，但工作台读取的是 `vcpLog`，日志通道不一致导致 UI 无记录。位置：`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:126`、`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:154`、`cherry-studio/src/renderer/src/pages/vcp/WorkbenchPanel.tsx:212`、`cherry-studio/src/renderer/src/pages/vcp/WorkbenchPanel.tsx:279`
- `vcp:knowledge:search` 仅使用 LightMemo（BM25）检索，未接入三段式检索与统一记忆层。位置：`cherry-studio/src/main/services/vcp/VCPPluginIpcHandler.ts:1652`、`cherry-studio/src/main/services/vcp/VCPPluginIpcHandler.ts:1664`
- NativeKnowledgeService 在 LightMemo 搜索中每次构建索引，且深度检索/网状检索与入口未对齐，存在性能与结果一致性风险。位置：`cherry-studio/src/main/services/NativeKnowledgeService.ts:483`、`cherry-studio/src/main/services/NativeKnowledgeService.ts:494`、`cherry-studio/src/main/services/NativeKnowledgeService.ts:523`、`cherry-studio/src/main/services/NativeKnowledgeService.ts:553`
- UnifiedMemoryManager 仍依赖已标记弃用的 AdvancedMemoryIpcHandler，未切换到统一 MemoryGateway。位置：`cherry-studio/src/main/services/UnifiedMemoryManager.ts:49`、`cherry-studio/src/main/services/AdvancedMemoryIpcHandler.ts:7`

## 重复实现/未复用清单
- VCPToolBox 协议解析逻辑重复实现两套（VCPProtocolParser 与 vcpContextPlugin），且归一化规则不一致。位置：`cherry-studio/src/renderer/src/aiCore/legacy/clients/vcp/VCPProtocolParser.ts:81`、`cherry-studio/src/renderer/src/aiCore/legacy/clients/vcp/VCPProtocolParser.ts:111`、`cherry-studio/src/renderer/src/aiCore/legacy/clients/vcp/VCPProtocolParser.ts:179`、`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:1336`、`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:1358`、`cherry-studio/src/renderer/src/aiCore/plugins/vcpContextPlugin.ts:1457`
- 日记 UI 重复实现：KnowledgeDiary 直接 IPC 调用并维护静态分组，未复用 VCP 的 DailyNotePanel。位置：`cherry-studio/src/renderer/src/pages/knowledge/items/KnowledgeDiary.tsx:93`、`cherry-studio/src/renderer/src/pages/knowledge/items/KnowledgeDiary.tsx:115`、`cherry-studio/src/renderer/src/pages/knowledge/items/KnowledgeDiary.tsx:126`、`cherry-studio/src/renderer/src/pages/vcp/panels/DailyNotePanel.tsx:133`
- 群聊 UI 重复实现：Home 的 GroupChatPanel 与 VCP 的 GroupChatManagement 分别维护相似功能。位置：`cherry-studio/src/renderer/src/pages/home/components/GroupChat/GroupChatPanel.tsx:97`、`cherry-studio/src/renderer/src/pages/vcp/GroupChatManagement.tsx:64`
